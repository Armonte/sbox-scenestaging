@using Sandbox;
@using Sandbox.UI;
@using Reclaimer;
@using System.Threading.Tasks;
@inherits PanelComponent

<root class="class-selection-panel @(IsTransitioningOut ? "transitioning-out" : "")">
	<div class="header">
		<h1>Choose Your Trinity Class</h1>
		<p>Select your role in the raid party</p>
	</div>
	
	<div class="class-grid">
		<div class="class-card @(CanSelectClass(TrinityClassType.Tank) ? "" : "disabled")" 
			 @onclick="@(() => SelectClass(TrinityClassType.Tank))">
			<div class="class-icon">ğŸ¢</div>
			<h3>Leo the Phranklyn</h3>
			<div class="class-role">TANK</div>
			<div class="class-description">
				@foreach(var item in GetTankFeatures())
				{
					<div class="feature">@item</div>
				}
			</div>
			<div class="class-status">
				@if (SpawnManager?.TankCount >= 1)
				{
					<span class="full">Role Filled</span>
				}
				else
				{
					<span class="available">Available</span>
				}
			</div>
		</div>
		
		
		<div class="class-card @(CanSelectClass(TrinityClassType.Healer) ? "" : "disabled")"
			 @onclick="@(() => SelectClass(TrinityClassType.Healer))">
			<div class="class-icon">ğŸ¥›</div>
			<h3>Holy Milker Abby</h3>
			<div class="class-role">HEALER</div>
			<div class="class-description">
				@foreach(var item in GetHealerFeatures())
				{
					<div class="feature">@item</div>
				}
			</div>
			<div class="class-status">
				@if (SpawnManager?.HealerCount >= 2)
				{
					<span class="full">Role Filled</span>
				}
				else
				{
					<span class="available">@(2 - (SpawnManager?.HealerCount ?? 0)) Slots</span>
				}
			</div>
		</div>
		
		<div class="class-card @(CanSelectClass(TrinityClassType.DPS) ? "" : "disabled")"
			 @onclick="@(() => SelectClass(TrinityClassType.DPS))">
			<div class="class-icon">ğŸ˜</div>
			<h3>Mighty Trunk Warrior</h3>
			<div class="class-role">DPS</div>
			<div class="class-description">
				@foreach(var item in GetDPSFeatures())
				{
					<div class="feature">@item</div>
				}
			</div>
			<div class="class-status">
				@if (SpawnManager?.DPSCount >= 2)
				{
					<span class="full">Role Filled</span>
				}
				else
				{
					<span class="available">@(2 - (SpawnManager?.DPSCount ?? 0)) Slots</span>
				}
			</div>
		</div>
	</div>
	
	<div class="party-status">
		<h3>Current Party Composition</h3>
		<div class="party-members">
			<div class="role-count">
				<span class="role-icon">ğŸ¢</span>
				<span class="count">@(SpawnManager?.TankCount ?? 0)/1</span>
			</div>
			<div class="role-count">
				<span class="role-icon">ğŸ¥›</span>
				<span class="count">@(SpawnManager?.HealerCount ?? 0)/2</span>
			</div>
			<div class="role-count">
				<span class="role-icon">ğŸ˜</span>
				<span class="count">@(SpawnManager?.DPSCount ?? 0)/2</span>
			</div>
		</div>
		@if (SpawnManager?.IsPartyComplete() ?? false)
		{
			<div class="party-ready">Party Ready!</div>
		}
	</div>
</root>

@code {
	TrinitySpawnManager SpawnManager => Scene?.GetAllComponents<TrinitySpawnManager>().FirstOrDefault();
	ClassSelectionUI Selector => Scene?.GetAllComponents<ClassSelectionUI>().FirstOrDefault();
	
	[Sync] public bool IsTransitioningOut { get; set; } = false;
	
	string[] GetTankFeatures()
	{
		return new string[]
		{
			"â€¢ Shell parry system",
			"â€¢ High survivability", 
			"â€¢ Summons Lil Frank",
			"â€¢ Lactose intolerant"
		};
	}
	
	string[] GetHealerFeatures()
	{
		return new string[]
		{
			"â€¢ Dual gun system",
			"â€¢ Milk resource management",
			"â€¢ Divine Spill ultimate",
			"â€¢ Portal teleportation"
		};
	}
	
	string[] GetDPSFeatures()
	{
		return new string[]
		{
			"â€¢ 12-level trunk progression",
			"â€¢ Combo system",
			"â€¢ Reality-bending ultimates", 
			"â€¢ Trunk pun obsession"
		};
	}
	
	bool CanSelectClass(TrinityClassType classType)
	{
		if (SpawnManager == null) return false;
		
		return classType switch
		{
			TrinityClassType.Tank => SpawnManager.TankCount < 1,
			TrinityClassType.Healer => SpawnManager.HealerCount < 2,
			TrinityClassType.DPS => SpawnManager.DPSCount < 2,
			_ => false
		};
	}
	
	void SelectClass(TrinityClassType classType)
	{
		if (!CanSelectClass(classType) || IsTransitioningOut)
		{
			Log.Warning($"Cannot select {classType} - role is full or already transitioning");
			return;
		}
		
		Log.Info($"Starting class selection: {classType}");
		IsTransitioningOut = true;
		StateHasChanged();
		
		Selector?.RequestClassSelection(classType);
	}
	
	protected override int BuildHash()
	{
		return HashCode.Combine(
			SpawnManager?.TankCount,
			SpawnManager?.HealerCount,
			SpawnManager?.DPSCount,
			IsTransitioningOut
		);
	}
}